{% extends 'base.html.twig' %}

{% block title %}Liste des imprimantes{% endblock %}

{% block body %}
<div class="container-fluid px-3 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h1><i class="bi bi-printer"></i> Liste des imprimantes</h1>
        <a href="{{ path('app_imprimante_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nouvelle imprimante
        </a>
    </div>

    {% if imprimantes is not empty %}
        {# Barre de recherche #}
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label">
                            <i class="bi bi-search"></i> Recherche
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="searchInput" 
                               placeholder="Numéro de série, modèle, site, IP...">
                        <small class="text-muted">Recherche en temps réel</small>
                    </div>
                    <div class="col-md-3">
                        <label for="statutFilter" class="form-label">
                            <i class="bi bi-filter"></i> Filtrer par statut
                        </label>
                        <select class="form-select" id="statutFilter">
                            <option value="">Tous les statuts</option>
                            <option value="actif">Actif</option>
                            <option value="pret">Prêt</option>
                            <option value="assurance">Assurance</option>
                            <option value="hs">Hors service</option>
                            <option value="decheterie">Déchetterie</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="serviceFilter" class="form-label">
                            <i class="bi bi-gear"></i> Géré par service
                        </label>
                        <select class="form-select" id="serviceFilter">
                            <option value="">Tous</option>
                            <option value="1">Oui</option>
                            <option value="0">Non</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="resetFilters">
                        <i class="bi bi-x-circle"></i> Réinitialiser les filtres
                    </button>
                    <span class="ms-3 text-muted">
                        <span id="resultCount">{{ imprimantes|length }}</span> imprimante(s) affichée(s)
                    </span>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Numéro de série</th>
                            <th>Modèle</th>
                            <th>Site</th>
                            <th>Adresse IP</th>
                            <th>Emplacement</th>
                            <th>Géré par service</th>
                            <th>Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="imprimantesTableBody">
                        {% for imprimante in imprimantes %}
                            <tr data-numero-serie="{{ imprimante.numeroSerie|lower }}" 
                                data-modele="{{ imprimante.modele.referenceModele|lower }}"
                                data-fabricant="{{ imprimante.modele.fabricant.nomFabricant|lower }}"
                                data-site="{{ imprimante.site.nomSite|lower }}"
                                data-ip="{{ imprimante.adresseIp|lower }}"
                                data-statut="{{ imprimante.statut.value }}"
                                data-service="{{ imprimante.suivieParService ? '1' : '0' }}">
                                <td><strong>{{ imprimante.numeroSerie }}</strong></td>
                                <td>
                                    {{ imprimante.modele.fabricant.nomFabricant }} {{ imprimante.modele.referenceModele }}{% if imprimante.dualScan %} <span class="badge bg-info">A</span>{% endif %}
                                </td>
                                <td>
                                    <a href="{{ path('app_site_show', {'id': imprimante.site.id}) }}">
                                        {{ imprimante.site.nomSite }}
                                    </a>
                                </td>
                                <td><code>{{ imprimante.adresseIp ?? '-' }}</code></td>
                                <td>{{ imprimante.emplacement ?? '-' }}</td>
                                <td>
                                    <span class="badge bg-{{ imprimante.suivieParService ? 'success' : 'secondary' }}">
                                        {{ imprimante.suivieParService ? 'Oui' : 'Non' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{{ imprimante.statut.value == 'actif' ? 'success' : (imprimante.statut.value == 'hs' ? 'danger' : 'warning') }}">
                                        {{ imprimante.statut.value|upper }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a href="{{ path('app_imprimante_show', {'id': imprimante.id}) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ path('app_imprimante_edit', {'id': imprimante.id}) }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <script>
        (function() {
            const searchInput = document.getElementById('searchInput');
            const statutFilter = document.getElementById('statutFilter');
            const serviceFilter = document.getElementById('serviceFilter');
            const resetFilters = document.getElementById('resetFilters');
            const resultCount = document.getElementById('resultCount');
            const tableBody = document.getElementById('imprimantesTableBody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));

            function filterRows() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedStatut = statutFilter.value;
                const selectedService = serviceFilter.value;

                let visibleCount = 0;

                rows.forEach(row => {
                    const numeroSerie = row.getAttribute('data-numero-serie') || '';
                    const modele = row.getAttribute('data-modele') || '';
                    const fabricant = row.getAttribute('data-fabricant') || '';
                    const site = row.getAttribute('data-site') || '';
                    const ip = row.getAttribute('data-ip') || '';
                    const statut = row.getAttribute('data-statut') || '';
                    const service = row.getAttribute('data-service') || '';

                    // Filtre par recherche
                    const matchesSearch = !searchTerm || 
                        numeroSerie.includes(searchTerm) || 
                        modele.includes(searchTerm) ||
                        fabricant.includes(searchTerm) ||
                        site.includes(searchTerm) ||
                        ip.includes(searchTerm);

                    // Filtre par statut
                    const matchesStatut = !selectedStatut || 
                        statut === selectedStatut;

                    // Filtre par service
                    const matchesService = !selectedService || 
                        service === selectedService;

                    // Afficher ou masquer la ligne
                    if (matchesSearch && matchesStatut && matchesService) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Mettre à jour le compteur
                resultCount.textContent = visibleCount;

                // Afficher un message si aucun résultat
                if (visibleCount === 0) {
                    if (!document.getElementById('noResultsMessage')) {
                        const noResults = document.createElement('tr');
                        noResults.id = 'noResultsMessage';
                        noResults.innerHTML = `
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="bi bi-search"></i> Aucune imprimante ne correspond aux critères de recherche
                            </td>
                        `;
                        tableBody.appendChild(noResults);
                    }
                } else {
                    const noResults = document.getElementById('noResultsMessage');
                    if (noResults) {
                        noResults.remove();
                    }
                }
            }

            // Événements
            searchInput.addEventListener('input', filterRows);
            statutFilter.addEventListener('change', filterRows);
            serviceFilter.addEventListener('change', filterRows);

            resetFilters.addEventListener('click', function() {
                searchInput.value = '';
                statutFilter.value = '';
                serviceFilter.value = '';
                filterRows();
                searchInput.focus();
            });

            // Initialisation
            filterRows();
        })();
        </script>
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Aucune imprimante dans le catalogue.
        </div>
    {% endif %}
</div>
{% endblock %}
