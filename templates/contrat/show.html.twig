{% extends 'base.html.twig' %}

{% block title %}Contrat - {{ contrat.reference }}{% endblock %}

{% block body %}
<div class="container-fluid px-3 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h1>
                <i class="bi bi-file-earmark-text"></i> {{ contrat.reference }}
            </h1>
            <p class="text-muted mb-0">
                <span class="badge bg-{{ contrat.statut.value == 'ACTIF' ? 'success' : (contrat.statut.value == 'BROUILLON' ? 'warning' : 'secondary') }}">
                    {{ contrat.statut.value }}
                </span>
                <span class="badge bg-secondary ms-2">{{ contrat.typeContrat.value }}</span>
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ path('app_contrat_edit', {'id': contrat.id}) }}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Modifier
            </a>
            <a href="{{ path('app_contrat_index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Client</dt>
                        <dd class="col-sm-8">
                            <a href="{{ path('app_client_show', {'id': contrat.client.id}) }}" class="text-decoration-none">
                                {{ contrat.client.nom }}
                            </a>
                        </dd>

                        <dt class="col-sm-4">Référence</dt>
                        <dd class="col-sm-8"><strong>{{ contrat.reference }}</strong></dd>

                        <dt class="col-sm-4">Type</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-secondary">{{ contrat.typeContrat.value }}</span>
                        </dd>

                        <dt class="col-sm-4">Date de début</dt>
                        <dd class="col-sm-8">{{ contrat.dateDebut|date('d/m/Y') }}</dd>

                        <dt class="col-sm-4">Date de fin</dt>
                        <dd class="col-sm-8">
                            {% if contrat.dateFin %}
                                {{ contrat.dateFin|date('d/m/Y') }}
                            {% else %}
                                <span class="text-muted">Non définie</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Statut</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-{{ contrat.statut.value == 'ACTIF' ? 'success' : (contrat.statut.value == 'BROUILLON' ? 'warning' : 'secondary') }}">
                                {{ contrat.statut.value }}
                            </span>
                        </dd>

                        {% if contrat.notes %}
                            <dt class="col-sm-4">Notes</dt>
                            <dd class="col-sm-8">{{ contrat.notes|nl2br }}</dd>
                        {% endif %}

                        <dt class="col-sm-4">Créé le</dt>
                        <dd class="col-sm-8">{{ contrat.createdAt|date('d/m/Y H:i') }}</dd>
                    </dl>
                </div>
            </div>

            {# Lignes de contrat avec détails de facturation #}
            {% if contrat.contratLignes is empty %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4 text-center text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <p class="mb-0">Aucune ligne de contrat</p>
                        <a href="{{ path('app_contrat_ligne_new') }}" class="btn btn-sm btn-primary mt-3">
                            <i class="bi bi-plus-circle"></i> Ajouter une ligne
                        </a>
                    </div>
                </div>
            {% else %}
                {% for item in lignesAvecFacturation %}
                    {% set ligne = item.ligne %}
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-list-ul"></i> {{ ligne.libelle }}
                                    {% if not ligne.actif %}
                                        <span class="badge bg-secondary ms-2">Inactif</span>
                                    {% endif %}
                                </h5>
                                <small class="text-muted">
                                    Site: <a href="{{ path('app_site_show', {'id': ligne.site.id}) }}" class="text-decoration-none">{{ ligne.site.nomSite }}</a>
                                    | Périodicité: <span class="badge bg-info">{{ ligne.periodicite.value }}</span>
                                    | Prochaine facturation: {{ ligne.prochaineFacturation|date('d/m/Y') }}
                                </small>
                            </div>
                            <a href="{{ path('app_contrat_ligne_show', {'id': ligne.id}) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> Détails
                            </a>
                        </div>
                        <div class="card-body">
                            {# Informations tarifaires #}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Tarifs</h6>
                                    <dl class="row mb-0 small">
                                        {% if ligne.prixFixe %}
                                            <dt class="col-sm-6">Prix fixe:</dt>
                                            <dd class="col-sm-6"><strong>{{ ligne.prixFixe|number_format(2, ',', ' ') }} €</strong></dd>
                                        {% endif %}
                                        {% if ligne.prixPageNoir %}
                                            <dt class="col-sm-6">Prix page noir:</dt>
                                            <dd class="col-sm-6">{{ ligne.prixPageNoir|number_format(4, ',', ' ') }} €</dd>
                                        {% endif %}
                                        {% if ligne.prixPageCouleur %}
                                            <dt class="col-sm-6">Prix page couleur:</dt>
                                            <dd class="col-sm-6">{{ ligne.prixPageCouleur|number_format(4, ',', ' ') }} €</dd>
                                        {% endif %}
                                        {% if ligne.pagesInclusesNoir %}
                                            <dt class="col-sm-6">Pages incluses (N):</dt>
                                            <dd class="col-sm-6">{{ ligne.pagesInclusesNoir }}</dd>
                                        {% endif %}
                                        {% if ligne.pagesInclusesCouleur %}
                                            <dt class="col-sm-6">Pages incluses (C):</dt>
                                            <dd class="col-sm-6">{{ ligne.pagesInclusesCouleur }}</dd>
                                        {% endif %}
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Imprimantes affectées</h6>
                                    {% if ligne.affectationsMateriel|length > 0 %}
                                        <ul class="list-unstyled mb-0 small">
                                            {% for affectation in ligne.affectationsMateriel %}
                                                {% if affectation.dateFin is null %}
                                                    <li>
                                                        <i class="bi bi-printer"></i> 
                                                        {{ affectation.imprimante.numeroSerie }}
                                                        <span class="badge bg-success ms-1">Active</span>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted small mb-0">Aucune imprimante affectée</p>
                                    {% endif %}
                                </div>
                            </div>

                            {# Compteurs et estimation #}
                            {% if (item.derniereFacture is defined and item.derniereFacture) or (item.compteursActuels is defined and item.compteursActuels|length > 0) %}
                                <div class="card border-info mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="bi bi-graph-up"></i> Compteurs et estimation
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {# Dernière facture #}
                                        {% if item.derniereFacture is defined and item.derniereFacture %}
                                            <h6 class="text-muted mb-2">Dernière facture ({{ item.derniereFacture.periode.dateFin|date('d/m/Y') }})</h6>
                                            <div class="table-responsive mb-3">
                                                <table class="table table-sm table-bordered">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Imprimante</th>
                                                            <th class="text-end">Compteur début (N)</th>
                                                            <th class="text-end">Compteur fin (N)</th>
                                                            <th class="text-end">Pages N</th>
                                                            <th class="text-end">Compteur début (C)</th>
                                                            <th class="text-end">Compteur fin (C)</th>
                                                            <th class="text-end">Pages C</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for compteur in item.derniereFacture.compteurs %}
                                                            <tr>
                                                                <td><small>{{ compteur.imprimante.numeroSerie }}</small></td>
                                                                <td class="text-end">{{ compteur.compteurDebutNoir|number_format(0, ',', ' ') }}</td>
                                                                <td class="text-end">
                                                                    {{ compteur.compteurFinNoir|number_format(0, ',', ' ') }}
                                                                    {% if compteur.compteurFinEstime is defined and compteur.compteurFinEstime %}
                                                                        <span class="badge bg-warning ms-1" title="Compteur estimé">Est.</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-end"><strong class="text-primary">{{ compteur.pagesNoir|number_format(0, ',', ' ') }}</strong></td>
                                                                <td class="text-end">
                                                                    {% if compteur.compteurDebutCouleur %}
                                                                        {{ compteur.compteurDebutCouleur|number_format(0, ',', ' ') }}
                                                                    {% else %}
                                                                        <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-end">
                                                                    {% if compteur.compteurFinCouleur %}
                                                                        {{ compteur.compteurFinCouleur|number_format(0, ',', ' ') }}
                                                                        {% if compteur.compteurFinEstime is defined and compteur.compteurFinEstime %}
                                                                            <span class="badge bg-warning ms-1" title="Compteur estimé">Est.</span>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-end"><strong class="text-info">{{ compteur.pagesCouleur|number_format(0, ',', ' ') }}</strong></td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% endif %}

                                        {# Compteurs actuels et estimation #}
                                        {% if item.estimation is defined and item.estimation.estimations|length > 0 %}
                                            {% set joursRestants = item.estimation.estimations[0].joursRestants %}
                                            <h6 class="text-muted mb-2">
                                                Estimation pour le {{ item.estimation.prochaineFacturation|date('d/m/Y') }}
                                                <small class="text-muted">({{ joursRestants }} jours restants)</small>
                                            </h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Imprimante</th>
                                                            <th class="text-end">Compteur début (N)</th>
                                                            <th class="text-end">Compteur actuel (N)</th>
                                                            <th class="text-end">Estimation (N)</th>
                                                            <th class="text-end">Pages estimées (N)</th>
                                                            <th class="text-end">Compteur début (C)</th>
                                                            <th class="text-end">Compteur actuel (C)</th>
                                                            <th class="text-end">Estimation (C)</th>
                                                            <th class="text-end">Pages estimées (C)</th>
                                                            <th class="text-center">Moyenne/jour</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for est in item.estimation.estimations %}
                                                            <tr>
                                                                <td>
                                                                    <small>
                                                                        <strong>{{ est.imprimante.numeroSerie }}</strong><br>
                                                                        <span class="text-muted">{{ est.dateReleveActuel|date('d/m/Y') }}</span>
                                                                    </small>
                                                                </td>
                                                                <td class="text-end">{{ est.compteurDebutNoir|number_format(0, ',', ' ') }}</td>
                                                                <td class="text-end">{{ est.compteurActuelNoir|number_format(0, ',', ' ') }}</td>
                                                                <td class="text-end">
                                                                    <strong class="text-warning">{{ est.compteurEstimeNoir|number_format(0, ',', ' ') }}</strong>
                                                                </td>
                                                                <td class="text-end">
                                                                    <strong class="text-primary">{{ est.pagesEstimeesNoir|number_format(0, ',', ' ') }}</strong>
                                                                </td>
                                                                <td class="text-end">
                                                                    {% if est.compteurDebutCouleur %}
                                                                        {{ est.compteurDebutCouleur|number_format(0, ',', ' ') }}
                                                                    {% else %}
                                                                        <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-end">
                                                                    {% if est.compteurActuelCouleur %}
                                                                        {{ est.compteurActuelCouleur|number_format(0, ',', ' ') }}
                                                                    {% else %}
                                                                        <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-end">
                                                                    {% if est.compteurEstimeCouleur %}
                                                                        <strong class="text-warning">{{ est.compteurEstimeCouleur|number_format(0, ',', ' ') }}</strong>
                                                                    {% else %}
                                                                        <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-end">
                                                                    {% if est.pagesEstimeesCouleur %}
                                                                        <strong class="text-info">{{ est.pagesEstimeesCouleur|number_format(0, ',', ' ') }}</strong>
                                                                    {% else %}
                                                                        <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    <small>
                                                                        <span class="badge bg-dark">{{ est.consommationMoyenneJournaliereNoir|number_format(1, ',', ' ') }} N/j</span><br>
                                                                        {% if est.consommationMoyenneJournaliereCouleur > 0 %}
                                                                            <span class="badge bg-info mt-1">{{ est.consommationMoyenneJournaliereCouleur|number_format(1, ',', ' ') }} C/j</span>
                                                                        {% endif %}
                                                                    </small>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                    <tfoot class="table-light">
                                                        <tr>
                                                            <th colspan="4" class="text-end">Total pages estimées:</th>
                                                            <th class="text-end text-primary">{{ item.estimation.pagesNoirTotal|number_format(0, ',', ' ') }} N</th>
                                                            <th colspan="3"></th>
                                                            <th class="text-end text-info">{{ item.estimation.pagesCouleurTotal|number_format(0, ',', ' ') }} C</th>
                                                            <th></th>
                                                        </tr>
                                                        <tr>
                                                            <th colspan="8" class="text-end">Montant estimé:</th>
                                                            <th class="text-end text-success fs-5">{{ item.estimation.montantEstime|number_format(2, ',', ' ') }} €</th>
                                                            <th></th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle"></i> Aucune estimation disponible. Les compteurs doivent être relevés pour calculer l'estimation.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            {# Périodes de facturation avec sélection AJAX #}
                            {% if item.periodes|length > 0 %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="text-muted mb-0">
                                            <i class="bi bi-calendar-range"></i> Périodes de facturation ({{ item.periodes|length }})
                                        </h6>
                                        <select class="form-select form-select-sm periode-selector" 
                                                data-ligne-id="{{ ligne.id }}" 
                                                style="max-width: 300px;"
                                                id="periode-select-{{ ligne.id }}">
                                            <option value="">-- Sélectionner une période --</option>
                                            {% for itemPeriode in item.periodes %}
                                                {% set periode = itemPeriode.periode %}
                                                <option value="{{ periode.id }}" 
                                                        data-pages-noir="{{ itemPeriode.pagesNoir }}"
                                                        data-pages-couleur="{{ itemPeriode.pagesCouleur }}"
                                                        data-montant="{{ itemPeriode.montant }}">
                                                    {{ periode.dateDebut|date('d/m/Y') }} → {{ periode.dateFin|date('d/m/Y') }}
                                                    ({{ periode.statut.value }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                {# Zone de détails de la période sélectionnée (chargée via AJAX) #}
                                <div id="periode-details-{{ ligne.id }}" class="periode-details-container" style="display: none;">
                                    <div class="card border-primary mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-info-circle"></i> Détails de la période
                                                <span class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;">
                                                    <span class="visually-hidden">Chargement...</span>
                                                </span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="periode-content-{{ ligne.id }}">
                                                <p class="text-muted mb-0">Chargement des détails...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {# Liste des périodes (tableau récapitulatif) #}
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Période</th>
                                                <th>Pages</th>
                                                <th>Montant</th>
                                                <th>Statut</th>
                                                <th class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for itemPeriode in item.periodes %}
                                                {% set periode = itemPeriode.periode %}
                                                <tr>
                                                    <td>
                                                        <small>
                                                            <strong>{{ periode.dateDebut|date('d/m/Y') }}</strong><br>
                                                            <span class="text-muted">→ {{ periode.dateFin|date('d/m/Y') }}</span>
                                                        </small>
                                                    </td>
                                                    <td>
                                                        {% if itemPeriode.pagesNoir > 0 %}
                                                            <span class="badge bg-dark">{{ itemPeriode.pagesNoir }} N</span>
                                                        {% endif %}
                                                        {% if itemPeriode.pagesCouleur > 0 %}
                                                            <span class="badge bg-info ms-1">{{ itemPeriode.pagesCouleur }} C</span>
                                                        {% endif %}
                                                        {% if itemPeriode.pagesNoir == 0 and itemPeriode.pagesCouleur == 0 %}
                                                            <span class="text-muted small">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <strong class="text-success">{{ itemPeriode.montant|number_format(2, ',', ' ') }} €</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-{{ periode.statut.value == 'FACTURE' ? 'success' : (periode.statut.value == 'VALIDE' ? 'primary' : 'warning') }}">
                                                            {{ periode.statut.value }}
                                                        </span>
                                                    </td>
                                                    <td class="text-end">
                                                        <a href="{{ path('app_comptabilite_periode_show', {'id': periode.id}) }}" class="btn btn-sm btn-outline-primary" title="Voir les détails">
                                                            <i class="bi bi-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> Aucune période de facturation pour cette ligne.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="col-12 col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-tools"></i> Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_contrat_edit', {'id': contrat.id}) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Modifier
                        </a>
                        <a href="{{ path('app_contrat_configure', {'id': contrat.id}) }}" class="btn btn-success">
                            <i class="bi bi-gear"></i> Configurer
                        </a>
                        <a href="{{ path('app_contrat_ligne_new', {'contrat_id': contrat.id}) }}" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Ajouter une ligne
                        </a>
                        {{ include('contrat/_delete_form.html.twig') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gérer la sélection de période pour chaque ligne de contrat
    document.querySelectorAll('.periode-selector').forEach(function(select) {
        select.addEventListener('change', function() {
            const periodeId = this.value;
            const ligneId = this.dataset.ligneId;
            const detailsContainer = document.getElementById('periode-details-' + ligneId);
            const contentDiv = document.getElementById('periode-content-' + ligneId);
            const spinner = detailsContainer.querySelector('.spinner-border');

            if (!periodeId) {
                detailsContainer.style.display = 'none';
                return;
            }

            // Afficher le conteneur et le spinner
            detailsContainer.style.display = 'block';
            spinner.style.display = 'inline-block';
            contentDiv.innerHTML = '<p class="text-muted mb-0">Chargement des détails...</p>';

            // Appel AJAX
            const url = '{{ path('app_comptabilite_periode_details_ajax', {'id': 0}) }}'.replace('/0', '/' + periodeId);
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                
                if (data.success) {
                    let html = '<div class="row g-3">';
                    
                    // Informations de la période
                    html += '<div class="col-12">';
                    html += '<h6 class="mb-2">Période: ' + data.periode.dateDebut + ' → ' + data.periode.dateFin + '</h6>';
                    html += '<p class="mb-2">';
                    html += '<span class="badge bg-' + (data.periode.statut === 'FACTURE' ? 'success' : (data.periode.statut === 'VALIDE' ? 'primary' : 'warning')) + '">' + data.periode.statut + '</span>';
                    html += '</p>';
                    html += '</div>';

                    // Résumé du calcul
                    html += '<div class="col-md-6">';
                    html += '<h6 class="text-muted mb-2">Résumé</h6>';
                    html += '<dl class="row mb-0 small">';
                    html += '<dt class="col-sm-6">Pages noir:</dt>';
                    html += '<dd class="col-sm-6"><strong>' + esc(data.calcul.pagesNoir) + '</strong></dd>';
                    html += '<dt class="col-sm-6">Pages couleur:</dt>';
                    html += '<dd class="col-sm-6"><strong>' + esc(data.calcul.pagesCouleur) + '</strong></dd>';
                    html += '<dt class="col-sm-6">Montant total:</dt>';
                    html += '<dd class="col-sm-6"><strong class="text-success">' + esc(parseFloat(data.calcul.montant).toFixed(2).replace('.', ',')) + ' €</strong></dd>';
                    html += '</dl>';
                    html += '</div>';

                    // Détails tarifaires
                    html += '<div class="col-md-6">';
                    html += '<h6 class="text-muted mb-2">Tarifs appliqués</h6>';
                    html += '<dl class="row mb-0 small">';
                    if (data.contratLigne.prixFixe) {
                        html += '<dt class="col-sm-6">Prix fixe:</dt>';
                        html += '<dd class="col-sm-6">' + esc(parseFloat(data.contratLigne.prixFixe).toFixed(2).replace('.', ',')) + ' €</dd>';
                    }
                    if (data.contratLigne.prixPageNoir) {
                        html += '<dt class="col-sm-6">Prix page noir:</dt>';
                        html += '<dd class="col-sm-6">' + esc(parseFloat(data.contratLigne.prixPageNoir).toFixed(4).replace('.', ',')) + ' €</dd>';
                    }
                    if (data.contratLigne.prixPageCouleur) {
                        html += '<dt class="col-sm-6">Prix page couleur:</dt>';
                        html += '<dd class="col-sm-6">' + esc(parseFloat(data.contratLigne.prixPageCouleur).toFixed(4).replace('.', ',')) + ' €</dd>';
                    }
                    html += '</dl>';
                    html += '</div>';

                    // Compteurs des imprimantes
                    if (data.compteurs && data.compteurs.length > 0) {
                        html += '<div class="col-12">';
                        html += '<h6 class="text-muted mb-2"><i class="bi bi-printer"></i> Compteurs des imprimantes</h6>';
                        html += '<div class="table-responsive">';
                        html += '<table class="table table-sm table-bordered mb-0">';
                        html += '<thead class="table-light">';
                        html += '<tr>';
                        html += '<th>Imprimante</th>';
                        html += '<th>Compteur début (N)</th>';
                        html += '<th>Compteur fin (N)</th>';
                        html += '<th>Pages N</th>';
                        html += '<th>Compteur début (C)</th>';
                        html += '<th>Compteur fin (C)</th>';
                        html += '<th>Pages C</th>';
                        html += '<th>Source</th>';
                        html += '<th>Statut</th>';
                        html += '</tr>';
                        html += '</thead>';
                        html += '<tbody>';
                        
                        data.compteurs.forEach(function(compteur) {
                            html += '<tr>';
                            html += '<td>';
                            html += '<strong>' + esc(compteur.imprimante.numeroSerie) + '</strong><br>';
                            html += '<small class="text-muted">' + esc(compteur.imprimante.modele);
                            if (compteur.imprimante.adresseIp) {
                                html += ' (' + esc(compteur.imprimante.adresseIp) + ')';
                            }
                            html += '</small><br>';
                            html += '<small class="text-muted">Affectation: ' + esc(compteur.affectation.dateDebut);
                            if (compteur.affectation.dateFin) {
                                html += ' → ' + esc(compteur.affectation.dateFin);
                            } else {
                                html += ' → En cours';
                            }
                            html += '</small>';
                            html += '</td>';
                            html += '<td class="text-end">' + esc(compteur.compteurs.debutNoir != null ? compteur.compteurs.debutNoir.toLocaleString('fr-FR') : '') + '</td>';
                            html += '<td class="text-end">' + esc(compteur.compteurs.finNoir != null ? compteur.compteurs.finNoir.toLocaleString('fr-FR') : '');
                            if (compteur.compteurs.compteurFinEstime) {
                                html += ' <span class="badge bg-warning ms-1" title="Compteur estimé">Est.</span>';
                            }
                            html += '</td>';
                            html += '<td class="text-end"><strong class="text-primary">' + esc(compteur.compteurs.pagesNoir != null ? compteur.compteurs.pagesNoir.toLocaleString('fr-FR') : '') + '</strong></td>';
                            html += '<td class="text-end">' + esc(compteur.compteurs.debutCouleur != null ? compteur.compteurs.debutCouleur.toLocaleString('fr-FR') : '-') + '</td>';
                            html += '<td class="text-end">';
                            if (compteur.compteurs.finCouleur != null) {
                                html += esc(compteur.compteurs.finCouleur.toLocaleString('fr-FR'));
                                if (compteur.compteurs.compteurFinEstime) {
                                    html += ' <span class="badge bg-warning ms-1" title="Compteur estimé">Est.</span>';
                                }
                            } else {
                                html += '-';
                            }
                            html += '</td>';
                            html += '<td class="text-end"><strong class="text-info">' + esc(compteur.compteurs.pagesCouleur != null ? compteur.compteurs.pagesCouleur.toLocaleString('fr-FR') : '0') + '</strong></td>';
                            html += '<td><small>' + esc(compteur.compteurs.sourceDebut) + ' → ' + esc(compteur.compteurs.sourceFin);
                            if (compteur.compteurs.dateReleveFin) {
                                html += '<br><small class="text-muted">' + esc(compteur.compteurs.dateReleveFin) + '</small>';
                            }
                            html += '</small></td>';
                            html += '<td>';
                            if (compteur.compteurs.compteurFinEstime) {
                                html += '<span class="badge bg-warning" title="Compteur de fin estimé">Estimé</span>';
                            } else {
                                html += '<span class="badge bg-success" title="Compteur de fin réel">Réel</span>';
                            }
                            html += '</td>';
                            html += '</tr>';
                        });
                        
                        html += '</tbody>';
                        html += '</table>';
                        html += '</div>';
                        html += '</div>';
                    } else {
                        html += '<div class="col-12">';
                        html += '<div class="alert alert-warning mb-0">';
                        html += '<i class="bi bi-exclamation-triangle"></i> Aucun compteur enregistré pour cette période.';
                        html += '</div>';
                        html += '</div>';
                    }

                    html += '</div>';
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = '<div class="alert alert-danger mb-0">Erreur lors du chargement des détails.</div>';
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                var msg = (typeof window.escapeHtml === 'function') ? window.escapeHtml(error.message) : String(error.message).replace(/[&<>"']/g, function(c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; });
                contentDiv.innerHTML = '<div class="alert alert-danger mb-0 d-flex align-items-center flex-wrap gap-2">' +
                    '<span class="flex-grow-1"><i class="bi bi-exclamation-triangle me-2"></i>Erreur: ' + msg + '</span>' +
                    '<button type="button" class="btn btn-outline-danger btn-sm periode-retry-btn" data-periode-id="' + periodeId + '" data-ligne-id="' + ligneId + '"><i class="bi bi-arrow-clockwise me-1"></i>Réessayer</button>' +
                    '</div>';
                contentDiv.querySelector('.periode-retry-btn').addEventListener('click', function() {
                    var sel = document.querySelector('.periode-selector[data-ligne-id="' + this.getAttribute('data-ligne-id') + '"]');
                    if (sel) { sel.value = this.getAttribute('data-periode-id'); sel.dispatchEvent(new Event('change')); }
                });
                console.error('Erreur AJAX:', error);
            });
        });
    });
});
</script>
{% endblock %}
