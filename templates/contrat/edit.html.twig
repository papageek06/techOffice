{% extends 'base.html.twig' %}

{% block title %}Modifier le contrat - {{ contrat.reference }}{% endblock %}

{% block body %}
<div class="container-fluid px-3 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h1>
                <i class="bi bi-pencil"></i> Modifier le contrat
            </h1>
            <p class="text-muted mb-0">{{ contrat.reference }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ path('app_contrat_show', {'id': contrat.id}) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Informations du contrat</h5>
                </div>
                <div class="card-body">
                    {{ include('contrat/_form.html.twig') }}
                </div>
            </div>

            {# Lignes de contrat avec détails de facturation #}
            {% if contrat.contratLignes is not empty %}
                {% for item in lignesAvecFacturation %}
                    {% set ligne = item.ligne %}
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-list-ul"></i> {{ ligne.libelle }}
                                    {% if not ligne.actif %}
                                        <span class="badge bg-secondary ms-2">Inactif</span>
                                    {% endif %}
                                </h5>
                                <small class="text-muted">
                                    Site: {{ ligne.site.nomSite }}
                                    | Périodicité: <span class="badge bg-info">{{ ligne.periodicite.value }}</span>
                                </small>
                            </div>
                            <a href="{{ path('app_contrat_ligne_show', {'id': ligne.id}) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> Détails
                            </a>
                        </div>
                        <div class="card-body">
                            {# Informations tarifaires #}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Tarifs</h6>
                                    <dl class="row mb-0 small">
                                        {% if ligne.prixFixe %}
                                            <dt class="col-sm-6">Prix fixe:</dt>
                                            <dd class="col-sm-6"><strong>{{ ligne.prixFixe|number_format(2, ',', ' ') }} €</strong></dd>
                                        {% endif %}
                                        {% if ligne.prixPageNoir %}
                                            <dt class="col-sm-6">Prix page noir:</dt>
                                            <dd class="col-sm-6">{{ ligne.prixPageNoir|number_format(4, ',', ' ') }} €</dd>
                                        {% endif %}
                                        {% if ligne.prixPageCouleur %}
                                            <dt class="col-sm-6">Prix page couleur:</dt>
                                            <dd class="col-sm-6">{{ ligne.prixPageCouleur|number_format(4, ',', ' ') }} €</dd>
                                        {% endif %}
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Pages incluses</h6>
                                    <dl class="row mb-0 small">
                                        {% if ligne.pagesInclusesNoir %}
                                            <dt class="col-sm-6">Noir:</dt>
                                            <dd class="col-sm-6">{{ ligne.pagesInclusesNoir }}</dd>
                                        {% endif %}
                                        {% if ligne.pagesInclusesCouleur %}
                                            <dt class="col-sm-6">Couleur:</dt>
                                            <dd class="col-sm-6">{{ ligne.pagesInclusesCouleur }}</dd>
                                        {% endif %}
                                    </dl>
                                </div>
                            </div>

                            {# Périodes de facturation avec sélection AJAX #}
                            {% if item.periodes|length > 0 %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="text-muted mb-0">
                                            <i class="bi bi-calendar-range"></i> Périodes de facturation ({{ item.periodes|length }})
                                        </h6>
                                        <select class="form-select form-select-sm periode-selector" 
                                                data-ligne-id="{{ ligne.id }}" 
                                                style="max-width: 300px;"
                                                id="periode-select-{{ ligne.id }}">
                                            <option value="">-- Sélectionner une période --</option>
                                            {% for itemPeriode in item.periodes %}
                                                {% set periode = itemPeriode.periode %}
                                                <option value="{{ periode.id }}">
                                                    {{ periode.dateDebut|date('d/m/Y') }} → {{ periode.dateFin|date('d/m/Y') }}
                                                    ({{ periode.statut.value }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                {# Zone de détails de la période sélectionnée (chargée via AJAX) #}
                                <div id="periode-details-{{ ligne.id }}" class="periode-details-container" style="display: none;">
                                    <div class="card border-primary mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-info-circle"></i> Détails de la période
                                                <span class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;">
                                                    <span class="visually-hidden">Chargement...</span>
                                                </span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="periode-content-{{ ligne.id }}">
                                                <p class="text-muted mb-0">Chargement des détails...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {# Liste des périodes (tableau récapitulatif) #}
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Période</th>
                                                <th>Pages</th>
                                                <th>Montant</th>
                                                <th>Statut</th>
                                                <th class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for itemPeriode in item.periodes %}
                                                {% set periode = itemPeriode.periode %}
                                                <tr>
                                                    <td>
                                                        <small>
                                                            <strong>{{ periode.dateDebut|date('d/m/Y') }}</strong><br>
                                                            <span class="text-muted">→ {{ periode.dateFin|date('d/m/Y') }}</span>
                                                        </small>
                                                    </td>
                                                    <td>
                                                        {% if itemPeriode.pagesNoir > 0 %}
                                                            <span class="badge bg-dark">{{ itemPeriode.pagesNoir }} N</span>
                                                        {% endif %}
                                                        {% if itemPeriode.pagesCouleur > 0 %}
                                                            <span class="badge bg-info ms-1">{{ itemPeriode.pagesCouleur }} C</span>
                                                        {% endif %}
                                                        {% if itemPeriode.pagesNoir == 0 and itemPeriode.pagesCouleur == 0 %}
                                                            <span class="text-muted small">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <strong class="text-success">{{ itemPeriode.montant|number_format(2, ',', ' ') }} €</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-{{ periode.statut.value == 'FACTURE' ? 'success' : (periode.statut.value == 'VALIDE' ? 'primary' : 'warning') }}">
                                                            {{ periode.statut.value }}
                                                        </span>
                                                    </td>
                                                    <td class="text-end">
                                                        <a href="{{ path('app_comptabilite_periode_show', {'id': periode.id}) }}" class="btn btn-sm btn-outline-primary" title="Voir les détails">
                                                            <i class="bi bi-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> Aucune période de facturation pour cette ligne.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="col-12 col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-sm-5">Client:</dt>
                        <dd class="col-sm-7">{{ contrat.client.nom }}</dd>
                        <dt class="col-sm-5">Type:</dt>
                        <dd class="col-sm-7"><span class="badge bg-secondary">{{ contrat.typeContrat.value }}</span></dd>
                        <dt class="col-sm-5">Statut:</dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-{{ contrat.statut.value == 'ACTIF' ? 'success' : (contrat.statut.value == 'BROUILLON' ? 'warning' : 'secondary') }}">
                                {{ contrat.statut.value }}
                            </span>
                        </dd>
                        <dt class="col-sm-5">Lignes:</dt>
                        <dd class="col-sm-7">{{ contrat.contratLignes|length }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gérer la sélection de période pour chaque ligne de contrat
    document.querySelectorAll('.periode-selector').forEach(function(select) {
        select.addEventListener('change', function() {
            const periodeId = this.value;
            const ligneId = this.dataset.ligneId;
            const detailsContainer = document.getElementById('periode-details-' + ligneId);
            const contentDiv = document.getElementById('periode-content-' + ligneId);
            const spinner = detailsContainer.querySelector('.spinner-border');

            if (!periodeId) {
                detailsContainer.style.display = 'none';
                return;
            }

            // Afficher le conteneur et le spinner
            detailsContainer.style.display = 'block';
            spinner.style.display = 'inline-block';
            contentDiv.innerHTML = '<p class="text-muted mb-0">Chargement des détails...</p>';

            // Appel AJAX
            const url = '{{ path('app_comptabilite_periode_details_ajax', {'id': 0}) }}'.replace('/0', '/' + periodeId);
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                
                if (data.success) {
                    let html = '<div class="row g-3">';
                    
                    // Informations de la période
                    html += '<div class="col-12">';
                    html += '<h6 class="mb-2">Période: ' + data.periode.dateDebut + ' → ' + data.periode.dateFin + '</h6>';
                    html += '<p class="mb-2">';
                    html += '<span class="badge bg-' + (data.periode.statut === 'FACTURE' ? 'success' : (data.periode.statut === 'VALIDE' ? 'primary' : 'warning')) + '">' + data.periode.statut + '</span>';
                    html += '</p>';
                    html += '</div>';

                    // Résumé du calcul
                    html += '<div class="col-md-6">';
                    html += '<h6 class="text-muted mb-2">Résumé</h6>';
                    html += '<dl class="row mb-0 small">';
                    html += '<dt class="col-sm-6">Pages noir:</dt>';
                    html += '<dd class="col-sm-6"><strong>' + data.calcul.pagesNoir + '</strong></dd>';
                    html += '<dt class="col-sm-6">Pages couleur:</dt>';
                    html += '<dd class="col-sm-6"><strong>' + data.calcul.pagesCouleur + '</strong></dd>';
                    html += '<dt class="col-sm-6">Montant total:</dt>';
                    html += '<dd class="col-sm-6"><strong class="text-success">' + parseFloat(data.calcul.montant).toFixed(2).replace('.', ',') + ' €</strong></dd>';
                    html += '</dl>';
                    html += '</div>';

                    // Détails tarifaires
                    html += '<div class="col-md-6">';
                    html += '<h6 class="text-muted mb-2">Tarifs appliqués</h6>';
                    html += '<dl class="row mb-0 small">';
                    if (data.contratLigne.prixFixe) {
                        html += '<dt class="col-sm-6">Prix fixe:</dt>';
                        html += '<dd class="col-sm-6">' + parseFloat(data.contratLigne.prixFixe).toFixed(2).replace('.', ',') + ' €</dd>';
                    }
                    if (data.contratLigne.prixPageNoir) {
                        html += '<dt class="col-sm-6">Prix page noir:</dt>';
                        html += '<dd class="col-sm-6">' + parseFloat(data.contratLigne.prixPageNoir).toFixed(4).replace('.', ',') + ' €</dd>';
                    }
                    if (data.contratLigne.prixPageCouleur) {
                        html += '<dt class="col-sm-6">Prix page couleur:</dt>';
                        html += '<dd class="col-sm-6">' + parseFloat(data.contratLigne.prixPageCouleur).toFixed(4).replace('.', ',') + ' €</dd>';
                    }
                    html += '</dl>';
                    html += '</div>';

                    // Compteurs des imprimantes
                    if (data.compteurs && data.compteurs.length > 0) {
                        html += '<div class="col-12">';
                        html += '<h6 class="text-muted mb-2"><i class="bi bi-printer"></i> Compteurs des imprimantes</h6>';
                        html += '<div class="table-responsive">';
                        html += '<table class="table table-sm table-bordered mb-0">';
                        html += '<thead class="table-light">';
                        html += '<tr>';
                        html += '<th>Imprimante</th>';
                        html += '<th>Compteur début (N)</th>';
                        html += '<th>Compteur fin (N)</th>';
                        html += '<th>Pages N</th>';
                        html += '<th>Compteur début (C)</th>';
                        html += '<th>Compteur fin (C)</th>';
                        html += '<th>Pages C</th>';
                        html += '<th>Source</th>';
                        html += '<th>Statut</th>';
                        html += '</tr>';
                        html += '</thead>';
                        html += '<tbody>';
                        
                        data.compteurs.forEach(function(compteur) {
                            html += '<tr>';
                            html += '<td>';
                            html += '<strong>' + compteur.imprimante.numeroSerie + '</strong><br>';
                            html += '<small class="text-muted">' + compteur.imprimante.modele;
                            if (compteur.imprimante.adresseIp) {
                                html += ' (' + compteur.imprimante.adresseIp + ')';
                            }
                            html += '</small><br>';
                            html += '<small class="text-muted">Affectation: ' + compteur.affectation.dateDebut;
                            if (compteur.affectation.dateFin) {
                                html += ' → ' + compteur.affectation.dateFin;
                            } else {
                                html += ' → En cours';
                            }
                            html += '</small>';
                            html += '</td>';
                            html += '<td class="text-end">' + compteur.compteurs.debutNoir.toLocaleString('fr-FR') + '</td>';
                            html += '<td class="text-end">' + compteur.compteurs.finNoir.toLocaleString('fr-FR');
                            if (compteur.compteurs.compteurFinEstime) {
                                html += ' <span class="badge bg-warning ms-1" title="Compteur estimé">Est.</span>';
                            }
                            html += '</td>';
                            html += '<td class="text-end"><strong class="text-primary">' + compteur.compteurs.pagesNoir.toLocaleString('fr-FR') + '</strong></td>';
                            html += '<td class="text-end">' + (compteur.compteurs.debutCouleur ? compteur.compteurs.debutCouleur.toLocaleString('fr-FR') : '-') + '</td>';
                            html += '<td class="text-end">';
                            if (compteur.compteurs.finCouleur) {
                                html += compteur.compteurs.finCouleur.toLocaleString('fr-FR');
                                if (compteur.compteurs.compteurFinEstime) {
                                    html += ' <span class="badge bg-warning ms-1" title="Compteur estimé">Est.</span>';
                                }
                            } else {
                                html += '-';
                            }
                            html += '</td>';
                            html += '<td class="text-end"><strong class="text-info">' + (compteur.compteurs.pagesCouleur ? compteur.compteurs.pagesCouleur.toLocaleString('fr-FR') : '0') + '</strong></td>';
                            html += '<td><small>' + compteur.compteurs.sourceDebut + ' → ' + compteur.compteurs.sourceFin;
                            if (compteur.compteurs.dateReleveFin) {
                                html += '<br><small class="text-muted">' + compteur.compteurs.dateReleveFin + '</small>';
                            }
                            html += '</small></td>';
                            html += '<td>';
                            if (compteur.compteurs.compteurFinEstime) {
                                html += '<span class="badge bg-warning" title="Compteur de fin estimé">Estimé</span>';
                            } else {
                                html += '<span class="badge bg-success" title="Compteur de fin réel">Réel</span>';
                            }
                            html += '</td>';
                            html += '</tr>';
                        });
                        
                        html += '</tbody>';
                        html += '</table>';
                        html += '</div>';
                        html += '</div>';
                    } else {
                        html += '<div class="col-12">';
                        html += '<div class="alert alert-warning mb-0">';
                        html += '<i class="bi bi-exclamation-triangle"></i> Aucun compteur enregistré pour cette période.';
                        html += '</div>';
                        html += '</div>';
                    }

                    html += '</div>';
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = '<div class="alert alert-danger mb-0">Erreur lors du chargement des détails.</div>';
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                contentDiv.innerHTML = '<div class="alert alert-danger mb-0">Erreur: ' + error.message + '</div>';
                console.error('Erreur AJAX:', error);
            });
        });
    });
});
</script>
{% endblock %}
