{% extends 'base.html.twig' %}

{% block title %}Pièce - {{ piece.reference }}{% endblock %}

{% block body %}
<div class="container-fluid px-3 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h1>
                <i class="bi bi-puzzle"></i> {{ piece.reference }}
            </h1>
            <p class="text-muted mb-0">{{ piece.designation }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ path('app_piece_edit', {'id': piece.id}) }}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Modifier
            </a>
            <a href="{{ path('app_piece_index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Référence</dt>
                        <dd class="col-sm-8"><strong>{{ piece.reference }}</strong></dd>

                        <dt class="col-sm-4">Désignation</dt>
                        <dd class="col-sm-8">{{ piece.designation }}</dd>

                        <dt class="col-sm-4">Type</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-secondary">{{ piece.typePiece.value }}</span>
                        </dd>

                        <dt class="col-sm-4">Couleur</dt>
                        <dd class="col-sm-8">
                            {% if piece.couleur %}
                                <span class="badge bg-dark">{{ piece.couleur }}</span>
                            {% else %}
                                <span class="text-muted">Non applicable</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Statut</dt>
                        <dd class="col-sm-8">
                            {% if piece.actif %}
                                <span class="badge bg-success">Actif</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactif</span>
                            {% endif %}
                        </dd>

                        {% if piece.notes %}
                            <dt class="col-sm-4">Notes</dt>
                            <dd class="col-sm-8">{{ piece.notes|nl2br }}</dd>
                        {% endif %}

                        <dt class="col-sm-4">Créé le</dt>
                        <dd class="col-sm-8">{{ piece.createdAt|date('d/m/Y H:i') }}</dd>

                        <dt class="col-sm-4">Modifié le</dt>
                        <dd class="col-sm-8">{{ piece.updatedAt|date('d/m/Y H:i') }}</dd>
                    </dl>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Compatibilités avec les modèles</h5>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#addModeleForm" aria-expanded="false">
                        <i class="bi bi-plus-circle"></i> Ajouter un modèle
                    </button>
                </div>
                
                {# Formulaire d'ajout de correspondance #}
                <div class="collapse" id="addModeleForm">
                    <div class="card-body border-bottom">
                        <form id="addModeleFormElement">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="modeleSelect" class="form-label">Modèle d'imprimante</label>
                                    <select class="form-select" id="modeleSelect" required>
                                        <option value="">Sélectionner un modèle...</option>
                                        {% for modele in modeles %}
                                            <option value="{{ modele.id }}">
                                                {{ modele.fabricant.nomFabricant }} {{ modele.referenceModele }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="roleSelect" class="form-label">Rôle</label>
                                    <select class="form-select" id="roleSelect" required>
                                        <option value="">Sélectionner un rôle...</option>
                                        <option value="TONER_K">Toner Noir (K)</option>
                                        <option value="TONER_C">Toner Cyan (C)</option>
                                        <option value="TONER_M">Toner Magenta (M)</option>
                                        <option value="TONER_Y">Toner Jaune (Y)</option>
                                        <option value="BAC_RECUP">Bac de récupération</option>
                                        <option value="DRUM">Tambour</option>
                                        <option value="FUSER">Unité de fusion</option>
                                        <option value="AUTRE">Autre</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100" id="addModeleBtn">
                                        <i class="bi bi-check-circle"></i> Ajouter
                                    </button>
                                </div>
                            </div>
                            <div id="addModeleError" class="alert alert-danger mt-2 d-none" role="alert"></div>
                            <div id="addModeleSuccess" class="alert alert-success mt-2 d-none" role="alert"></div>
                        </form>
                    </div>
                </div>

                <div class="card-body p-0">
                    {% if piece.pieceModeles is empty %}
                        <div class="p-4 text-center text-muted" id="emptyMessage">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            <p class="mb-0">Aucune compatibilité définie</p>
                        </div>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Modèle</th>
                                        <th>Rôle</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="compatibilitesTableBody">
                                    {% for pieceModele in piece.pieceModeles %}
                                        <tr data-piece-modele-id="{{ pieceModele.id }}">
                                            <td>
                                                <strong>{{ pieceModele.modele.fabricant.nomFabricant }} {{ pieceModele.modele.referenceModele }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ pieceModele.role.value|replace({'_': ' '}) }}</span>
                                            </td>
                                            <td class="text-end">
                                                <a href="{{ path('app_piece_modele_show', {'id': pieceModele.id}) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>

            <script>
            (function() {
                const addModeleForm = document.getElementById('addModeleFormElement');
                const modeleSelect = document.getElementById('modeleSelect');
                const roleSelect = document.getElementById('roleSelect');
                const addModeleBtn = document.getElementById('addModeleBtn');
                const errorDiv = document.getElementById('addModeleError');
                const successDiv = document.getElementById('addModeleSuccess');
                let tableBody = document.getElementById('compatibilitesTableBody');
                const emptyMessage = document.getElementById('emptyMessage');
                const addUrl = '{{ path('app_piece_add_modele', {'id': piece.id}) }}';
                const addModeleCsrfToken = '{{ csrf_token('piece_add_modele') }}';

                // Récupérer les modèles déjà associés pour les exclure du sélecteur
                const existingModeles = new Set();
                {% for pieceModele in piece.pieceModeles %}
                    existingModeles.add({{ pieceModele.modele.id }});
                {% endfor %}

                // Filtrer les options du sélecteur (masquer les modèles déjà associés avec le même rôle)
                function updateModeleSelect() {
                    const selectedRole = roleSelect.value;
                    Array.from(modeleSelect.options).forEach(option => {
                        if (option.value === '') return;
                        // Pour l'instant, on laisse tous les modèles disponibles
                        // On pourrait améliorer en vérifiant les rôles aussi
                    });
                }

                roleSelect.addEventListener('change', updateModeleSelect);

                addModeleForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const modeleId = modeleSelect.value;
                    const role = roleSelect.value;

                    if (!modeleId || !role) {
                        showError('Veuillez sélectionner un modèle et un rôle');
                        return;
                    }

                    // Désactiver le bouton pendant la requête
                    addModeleBtn.disabled = true;
                    addModeleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Ajout...';
                    hideMessages();

                    try {
                        const formData = new FormData();
                        formData.append('modele_id', modeleId);
                        formData.append('role', role);
                        formData.append('_token', addModeleCsrfToken);

                        const response = await fetch(addUrl, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData
                        });

                        const data = await response.json();

                        if (!response.ok || !data.success) {
                            showError(data.error || 'Erreur lors de l\'ajout de la correspondance');
                            return;
                        }

                        // Afficher le message de succès
                        showSuccess('Correspondance ajoutée avec succès !');

                        // Ajouter la nouvelle ligne au tableau
                        addRowToTable(data.pieceModele);

                        // Masquer le message vide si présent
                        if (emptyMessage) {
                            emptyMessage.style.display = 'none';
                        }

                        // Réinitialiser le formulaire
                        modeleSelect.value = '';
                        roleSelect.value = '';
                        updateModeleSelect();

                        // Masquer le formulaire après 1 seconde
                        setTimeout(() => {
                            const collapseElement = document.getElementById('addModeleForm');
                            if (collapseElement) {
                                const bsCollapse = bootstrap?.Collapse?.getInstance(collapseElement);
                                if (bsCollapse) {
                                    bsCollapse.hide();
                                } else {
                                    collapseElement.classList.remove('show');
                                }
                            }
                            hideMessages();
                        }, 1500);

                    } catch (error) {
                        console.error('Erreur:', error);
                        showError('Une erreur est survenue lors de l\'ajout. Vous pouvez réessayer.');
                    } finally {
                        addModeleBtn.disabled = false;
                        addModeleBtn.innerHTML = '<i class="bi bi-check-circle"></i> Ajouter';
                    }
                });

                function addRowToTable(pieceModele) {
                    let tbody = tableBody;
                    
                    // Créer la table si elle n'existe pas
                    if (!tbody) {
                        const cardBody = document.querySelector('.card-body.p-0');
                        const emptyDiv = cardBody.querySelector('#emptyMessage');
                        if (emptyDiv) {
                            emptyDiv.remove();
                        }

                        const tableHtml = `
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Modèle</th>
                                            <th>Rôle</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="compatibilitesTableBody"></tbody>
                                </table>
                            </div>
                        `;
                        cardBody.innerHTML = tableHtml;
                        tbody = document.getElementById('compatibilitesTableBody');
                        // Mettre à jour la référence globale
                        tableBody = tbody;
                    }

                    // Créer la nouvelle ligne (échappement XSS pour données API)
                    var esc = window.escapeHtml || function(s) { return (s == null ? '' : String(s)).replace(/[&<>"']/g, function(c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; }); };
                    const row = document.createElement('tr');
                    row.setAttribute('data-piece-modele-id', pieceModele.id);
                    const showUrl = '{{ path('app_piece_modele_show', {'id': 0}) }}'.replace('0', esc(pieceModele.id));
                    row.innerHTML = '<td><strong>' + esc(pieceModele.modele.fabricant) + ' ' + esc(pieceModele.modele.referenceModele) + '</strong></td>' +
                        '<td><span class="badge bg-info">' + esc(String(pieceModele.role).replace('_', ' ')) + '</span></td>' +
                        '<td class="text-end"><a href="' + showUrl + '" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i></a></td>';

                    // Ajouter la ligne au début du tableau
                    tbody.insertBefore(row, tbody.firstChild);

                    // Animation d'apparition
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '1';
                    }, 10);
                }

                function showError(message) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }

                function showSuccess(message) {
                    successDiv.textContent = message;
                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                }

                function hideMessages() {
                    errorDiv.classList.add('d-none');
                    successDiv.classList.add('d-none');
                }
            })();
            </script>
        </div>

        <div class="col-12 col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Stocks</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Emplacements:</strong> {{ piece.stockItems|length }}
                    </p>
                    <a href="{{ path('app_stock_item_index') }}" class="btn btn-sm btn-outline-primary w-100">
                        Voir les stocks
                    </a>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-tools"></i> Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_piece_edit', {'id': piece.id}) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Modifier
                        </a>
                        <a href="{{ path('app_piece_modele_new') }}" class="btn btn-outline-primary">
                            <i class="bi bi-link-45deg"></i> Ajouter une compatibilité
                        </a>
                        {{ include('piece/_delete_form.html.twig') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
